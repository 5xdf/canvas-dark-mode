name: Build & Deploy

# Controls when the action will run.
on:
  # Triggers the workflow on push to the master branch
  push:
    branches:
      - master
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build_and_release: # Renamed job for clarity
    runs-on: ubuntu-latest
    
    # Required permission to create a new tag and a release
    permissions:
      contents: write

    steps:
      # Checks out your repository code
      - uses: actions/checkout@v3

      # 1. Zip Plugin Artifact
      - name: Zip Plugin
        run: zip -r extension.zip ./plugin
      
      # 2. Calculate Next Version (v1.x)
      # This script finds the highest existing v1.x tag and increments the patch number (x).
      - name: Calculate Next Version
        id: versioning
        uses: actions/github-script@v6
        with:
          script: |
            const { data: tags } = await github.rest.repos.listTags({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100, // Fetch up to 100 tags
            });

            // Filter for tags starting with 'v1.' and find the highest patch number
            const v1Tags = tags
              .map(tag => tag.name)
              .filter(name => name.startsWith('v1.'))
              .map(name => ({
                original: name,
                // Extract the number after 'v1.'
                patch: parseInt(name.substring(2))
              }))
              .filter(tag => !isNaN(tag.patch))
              .sort((a, b) => b.patch - a.patch); // Sort descending

            let nextPatch = 0;
            if (v1Tags.length > 0) {
              // Increment the highest found patch version
              nextPatch = v1Tags[0].patch + 1;
            }
            
            const newTag = `v1.${nextPatch}`;
            
            // Set the new tag as an output variable for use in later steps
            core.setOutput('new_tag', newTag);
            console.log(`Calculated next tag: ${newTag}`);

      # 3. Create GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          # Use the calculated tag from the previous step. This action creates the tag automatically.
          tag_name: ${{ steps.versioning.outputs.new_tag }}
          name: Release ${{ steps.versioning.outputs.new_tag }}
          body: Automated release containing the latest build of the extension.
          # Attach the zipped extension to the release
          files: extension.zip 
          draft: false
          prerelease: false
        env:
          # GITHUB_TOKEN is automatically provided and required for creating the release
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      # 4. Upload a Build Artifact (for the GitHub Actions UI)
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v3
        with:
          name: extension
          path: extension.zip
          if-no-files-found: error
